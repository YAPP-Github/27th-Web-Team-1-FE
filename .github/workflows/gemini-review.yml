name: Gemini PR Review (File-based)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # PR base 브랜치 기준 diff 생성
      - name: Generate PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff

      # Gemini로 코드 리뷰 생성 (stdout → review.md)
      - name: Run Gemini review
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          settings: |
            {
              "model": "gemini-1.5-pro",
              "prompt": "You are a senior frontend engineer. Review the pull request strictly according to the provided config and style guide.\n\nRules:\n- Group feedback by file\n- Use the format:\n  ### <file path>\n  - [Blocker|Suggestion|Nitpick]: message\n- Do not comment on files without meaningful issues\n- Focus on architecture, naming, readability, performance\n- Be concise and actionable",
              "files": [
                ".gemini/config.yaml",
                ".gemini/styleguide.md",
                "pr.diff"
              ]
            }
        # Gemini CLI 출력물을 파일로 저장
        env:
          GEMINI_OUTPUT_FILE: review.md

      # Gemini 결과를 PR 코멘트로 등록
      - name: Post review comment to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f review.md ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file review.md
          else
            gh pr comment ${{ github.event.pull_request.number }} --body "Gemini review completed, but no output was generated."
          fi
