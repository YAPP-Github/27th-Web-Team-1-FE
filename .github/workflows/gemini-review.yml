name: Gemini PR Review (File-based)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # GitHub API로 PR diff 다운로드 (merge-base 문제 없음)
      - name: Download PR diff
        run: |
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.diff" \
            ${{ github.event.pull_request.url }} \
            > pr.diff

      # Gemini로 코드 리뷰 생성
      - name: Run Gemini review
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          settings: |
            {
              "model": "gemini-1.5-pro",
              "prompt": "You are a senior frontend engineer.\n\nReview the pull request strictly according to the provided config and style guide.\n\nRules:\n- Group feedback by file\n- Use the following format:\n  ### <file path>\n  - [Blocker|Suggestion|Nitpick]: message\n- Do not comment on files without meaningful issues\n- Blocker means: issues that can cause runtime errors, broken user flows, data inconsistency, or serious performance problems\n- Be concise, actionable, and avoid repeating lint-level issues\n",
              "files": [
                ".gemini/config.yaml",
                ".gemini/styleguide.md",
                "pr.diff"
              ]
            }
        env:
          GEMINI_OUTPUT_FILE: review.md

      # Gemini 리뷰 결과를 PR 코멘트로 등록
      - name: Post Gemini review as PR comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -s review.md ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file review.md
          else
            gh pr comment ${{ github.event.pull_request.number }} --body "Gemini review completed. No significant issues found."
          fi
