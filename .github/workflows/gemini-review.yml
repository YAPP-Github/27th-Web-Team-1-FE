name: Gemini PR Review (File-based)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # PR diff 다운로드
      - name: Download PR diff
        run: |
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.diff" \
            ${{ github.event.pull_request.url }} \
            > pr.diff

      # Gemini CLI 설치
      - name: Install Gemini CLI
        run: |
          npm install -g @google/generative-ai-cli

      # Gemini로 리뷰 생성
      - name: Run Gemini review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          gemini << 'EOF' > review.md
          You are a senior frontend engineer.

          Review the following pull request strictly according to the provided config and style guide.

          Rules:
          - Group feedback by file
          - Use the format:
            ### <file path>
            - [Blocker|Suggestion|Nitpick]: message
          - Do not comment on files without meaningful issues
          - Blocker means issues that can cause runtime errors, broken user flows, data inconsistency, or serious performance problems
          - Be concise and actionable

          --- CONFIG ---
          $(cat .gemini/config.yaml)

          --- STYLE GUIDE ---
          $(cat .gemini/styleguide.md)

          --- DIFF ---
          $(cat pr.diff)
          EOF

      # PR 코멘트 등록
      - name: Post Gemini review to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -s review.md ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file review.md
          else
            gh pr comment ${{ github.event.pull_request.number }} --body "Gemini review completed. No significant issues found."
          fi
